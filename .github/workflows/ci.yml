name: CI

permissions:
  contents: read
  security-events: read

on:
  push:
    branches: [main, development, staging]
  pull_request: {}
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (main only): patch | minor | major"
        required: true
        default: "patch"
        type: choice
        options: [patch, minor, major]
  schedule:
    - cron: "0 3 * * 0"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: âœ… Tests (${{ matrix.app }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: [backend, frontend]
    steps:
      - name: âœ¨ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            apps/backend/package-lock.json
            apps/frontend/package-lock.json

      - name: â¬†ï¸ Upgrade npm (fix rollup optional deps)
        run: |
          npm i -g npm@11.3.0
          npm -v

      - name: ğŸŸ© Install dependencies
        working-directory: apps/${{ matrix.app }}
        run: |
          if [ "${{ matrix.app }}" = "frontend" ]; then
            npm ci --legacy-peer-deps
          else
            npm ci
          fi

      - name: ğŸ§‘â€ğŸ¨ Lint
        working-directory: apps/${{ matrix.app }}
        run: npm run lint

      - name: ğŸ”¬ Unit tests
        working-directory: apps/${{ matrix.app }}
        run: |
          if [ "${{ matrix.app }}" = "frontend" ]; then
            echo "npm test (placeholder)"
          else
            npm test
          fi

  dependabot-vuln-scan:
    name: ğŸ¤– Dependabot vulnerability scan
    runs-on: ubuntu-latest
    needs: [tests]
    if: always()
    steps:
      - name: âœ¨ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            apps/backend/package-lock.json
            apps/frontend/package-lock.json

      - name: â¬†ï¸ Upgrade npm
        run: |
          npm i -g npm@11.3.0
          npm -v

      - name: ğŸ” npm audit (backend)
        working-directory: apps/backend
        run: |
          npm ci
          npm audit --audit-level=moderate

      - name: ğŸ” npm audit (frontend)
        working-directory: apps/frontend
        run: |
          npm ci --legacy-peer-deps
          npm audit --audit-level=moderate

  versioning:
    name: ğŸ·ï¸ Versioning (main / snapshot / RC)
    runs-on: ubuntu-latest
    needs: [tests, dependabot-vuln-scan]
    if: github.event_name != 'pull_request'
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: âœ¨ Checkout full history + tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/backend/package-lock.json

      - name: â¬†ï¸ Upgrade npm
        run: |
          npm i -g npm@11.3.0
          npm -v

      - name: ğŸ”§ Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ğŸ·ï¸ Compute + create tag (branch-aware)
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin --force --prune --tags

          # Anti-boucle: si c'est dÃ©jÃ  un commit de versioning, on stop
          LAST_MSG="$(git log -1 --pretty=%s)"
          if echo "$LAST_MSG" | grep -qE '^chore\((main|snapshot|rc)\):'; then
            echo "tag=$(git tag --sort=-creatordate | head -n 1)" >> "$GITHUB_OUTPUT"
            echo "Skip: versioning commit detected."
            exit 0
          fi

          # Dernier stable vX.Y.Z
          STABLE=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)
          BASE="${STABLE#v}"
          [ -z "${BASE:-}" ] && BASE="1.0.0"

          BRANCH="${GITHUB_REF_NAME}"

          if [ "$BRANCH" = "main" ]; then
            # Sur dispatch on a l'input, sur push c'est vide => patch
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            [ -z "${RELEASE_TYPE:-}" ] && RELEASE_TYPE="patch"

            IFS='.' read -r MA MI PA <<< "$BASE"
            case "$RELEASE_TYPE" in
              major) MA=$((MA+1)); MI=0; PA=0 ;;
              minor) MI=$((MI+1)); PA=0 ;;
              patch) PA=$((PA+1)) ;;
              *) echo "release_type invalide: $RELEASE_TYPE"; exit 1 ;;
            esac

            NEW="${MA}.${MI}.${PA}"
            TAG="v${NEW}"

            # bump package backend sans tag auto
            cd apps/backend
            npm version "${NEW}" --no-git-tag-version
            cd -

            git add apps/backend/package.json apps/backend/package-lock.json
            if git diff --cached --quiet; then
              echo "Nothing to commit (version dÃ©jÃ  Ã  ${NEW})"
              echo "tag=$(git tag --sort=-creatordate | head -n 1)" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG existe dÃ©jÃ "
              exit 1
            fi

            git commit -m "chore(main): ${TAG}"
            git tag "${TAG}"
            git push origin HEAD:main --follow-tags

            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$BRANCH" = "development" ]; then
            # vBASE-snapshot.N
            LAST=$(git tag --sort=-v:refname | grep -E "^v${BASE}-snapshot\.[0-9]+$" | head -n 1 || true)
            if [ -z "${LAST:-}" ]; then N=1; else N=$(( ${LAST##*.} + 1 )); fi
            TAG="v${BASE}-snapshot.${N}"

            cd apps/backend
            npm version "${BASE}-snapshot.${N}" --no-git-tag-version
            cd -

            git add apps/backend/package.json apps/backend/package-lock.json || true
            git commit -m "chore(snapshot): ${TAG}" || true
            git tag "${TAG}"
            git push origin HEAD:development --follow-tags

            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$BRANCH" = "staging" ]; then
            # vBASE-RC.N
            LAST=$(git tag --sort=-v:refname | grep -E "^v${BASE}-RC\.[0-9]+$" | head -n 1 || true)
            if [ -z "${LAST:-}" ]; then N=1; else N=$(( ${LAST##*.} + 1 )); fi
            TAG="v${BASE}-RC.${N}"

            cd apps/backend
            npm version "${BASE}-RC.${N}" --no-git-tag-version
            cd -

            git add apps/backend/package.json apps/backend/package-lock.json || true
            git commit -m "chore(rc): ${TAG}" || true
            git tag "${TAG}"
            git push origin HEAD:staging --follow-tags

            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Autres branches => pas de tag
          echo "tag=" >> "$GITHUB_OUTPUT"

  docker-build-push-acr-frontend:
    name: ğŸ³ Build & Push Docker image to ACR (frontend)
    runs-on: ubuntu-latest
    needs: [versioning]
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'development' || github.ref_name == 'staging')
    steps:
      - name: âœ¨ Checkout
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Docker tag
        run: |
          echo "Using tag: ${{ needs.versioning.outputs.tag }}"
          test -n "${{ needs.versioning.outputs.tag }}"

      - name: ğŸ” Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: cmatheo.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ğŸ—ï¸ Build & Push (frontend)
        run: |
          docker build -t cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }} apps/frontend
          docker push cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }}

      - name: ğŸ·ï¸ Tag & Push latest (main only)
        if: github.ref_name == 'main'
        run: |
          docker tag cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }} cmatheo.azurecr.io/frontend:latest
          docker push cmatheo.azurecr.io/frontend:latest

  docker-build-push-acr-backend:
    name: ğŸ³ Build & Push Docker image to ACR (backend)
    runs-on: ubuntu-latest
    needs: [versioning]
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'development' || github.ref_name == 'staging')
    steps:
      - name: âœ¨ Checkout
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Docker tag
        run: |
          echo "Using tag: ${{ needs.versioning.outputs.tag }}"
          test -n "${{ needs.versioning.outputs.tag }}"

      - name: ğŸ” Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: cmatheo.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ğŸ—ï¸ Build & Push (backend)
        run: |
          docker build -t cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }} apps/backend
          docker push cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }}

      - name: ğŸ·ï¸ Tag & Push latest (main only)
        if: github.ref_name == 'main'
        run: |
          docker tag cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }} cmatheo.azurecr.io/backend:latest
          docker push cmatheo.azurecr.io/backend:latest
