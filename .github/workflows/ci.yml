name: CI

permissions:
  contents: write
  security-events: read

on:
  push:
    branches: [main, development, staging]
  pull_request: {}
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (main only): patch | minor | major"
        required: true
        default: "patch"
        type: choice
        options: [patch, minor, major]
  schedule:
    - cron: '0 3 * * 0'

jobs:
  test:
    name: üß™ ${{ matrix.app }} tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.3.0
      - run: npm ci --legacy-peer-deps
        working-directory: apps/${{ matrix.app }}
      - run: npm run lint
        working-directory: apps/${{ matrix.app }}
      - run: ${{ matrix.app == 'backend' && 'npm test' || 'echo npm test' }}
        working-directory: apps/${{ matrix.app }}

  vuln-scan:
    name: üîê Security audit
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.3.0
      - run: for app in backend frontend; do (cd apps/$app && npm ci --legacy-peer-deps && npm audit --audit-level=moderate); done

  versioning:
    name: üè∑Ô∏è Versioning
    runs-on: ubuntu-latest
    needs: [test, vuln-scan]
    if: github.event_name != 'pull_request'
    outputs:
      tag: ${{ steps.out.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: true
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: |
          npm i -g npm@11.3.0
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin --force --prune --tags
      - name: üöÄ Release
        shell: bash
        run: |
          TYPE="${{ github.event.inputs.release_type || 'patch' }}"
          CURRENT=$(node -p "require('./apps/backend/package.json').version")
          
          if [[ "$CURRENT" =~ (-RC|-snapshot) ]]; then
            BASE=$(echo "$CURRENT" | sed 's/-RC.*//' | sed 's/-snapshot.*//')
            cd apps/backend && npm version "$BASE" --no-git-tag-version && cd ../..
            cd apps/frontend && npm version "$BASE" --no-git-tag-version && cd ../..
          fi
          
          if [ "${{ github.ref_name }}" = "main" ] && [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            cd apps/backend && npm version "$TYPE" --no-git-tag-version && cd ../..
            cd apps/frontend && npm version "$TYPE" --no-git-tag-version && cd ../..
            NEW=$(node -p "require('./apps/backend/package.json').version")
            git add apps/*/package*.json && git commit -m "chore(release): v$NEW" && git tag "v$NEW"
            git push origin HEAD:main && git push origin "v$NEW"
          elif [ "${{ github.ref_name }}" = "development" ]; then
            LATEST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "v1.0.0")
            BASE="${LATEST#v}" && BASE="${BASE%-snapshot*}"
            LAST=$(git tag --sort=-v:refname | grep "^v${BASE}-snapshot\." | head -1)
            N=$([[ -z "$LAST" ]] && echo 1 || echo $((${LAST##*.} + 1)))
            NEW="${BASE}-snapshot.${N}"
            cd apps/backend && npm version $NEW --no-git-tag-version 2>/dev/null || true && cd ../..
            cd apps/frontend && npm version $NEW --no-git-tag-version 2>/dev/null || true && cd ../..
            git add apps/*/package*.json && git commit -m "chore(snapshot): v$NEW" || true && git tag "v$NEW" --force
            git push origin HEAD:development || true && git push origin "v$NEW" --force || true
          elif [ "${{ github.ref_name }}" = "staging" ]; then
            LAST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | grep -v -E '(-RC|-snapshot)' | head -1 || true)
            BASE="${LAST#v}"; [[ -z "$BASE" ]] && BASE="1.0.0"; BASE="${BASE%-snapshot*}"
            LAST_RC=$(git tag --sort=-v:refname | grep -E "^v${BASE}-RC\." | head -1 || true)
            NEW="${BASE}-RC.$([[ -z "$LAST_RC" ]] && echo 1 || echo $((${LAST_RC##*-RC.} + 1)))"
            for app in backend frontend; do
              CURR=$(node -p "require('./apps/$app/package.json').version")
              [ "$CURR" != "$NEW" ] && (cd apps/$app && npm version "$NEW" --no-git-tag-version) || true
            done
            git add apps/*/package*.json || true && git commit -m "chore(rc): v$NEW" || true && git tag "v$NEW" --force
            git push origin HEAD:staging || true && git push origin "v$NEW" --force || true
          fi
      - name: üìå Output tag
        id: out
        shell: bash
        run: |
          git fetch origin --force --prune --tags
          TAG=$(git tag --points-at HEAD | head -1 || git tag --sort=-creatordate | head -1)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  docker:
    name: üê≥ Build ${{ matrix.app }} image
    runs-on: ubuntu-latest
    needs: [test, vuln-scan, versioning]
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'development' || github.ref_name == 'staging')
    strategy:
      matrix:
        app: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v1
        with:
          login-server: cmatheo.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - run: docker build -t cmatheo.azurecr.io/${{ matrix.app }}:${{ needs.versioning.outputs.tag }} apps/${{ matrix.app }}
      - run: docker push cmatheo.azurecr.io/${{ matrix.app }}:${{ needs.versioning.outputs.tag }}
      - if: github.ref_name == 'main'
        run: |
          docker tag cmatheo.azurecr.io/${{ matrix.app }}:${{ needs.versioning.outputs.tag }} cmatheo.azurecr.io/${{ matrix.app }}:latest
          docker push cmatheo.azurecr.io/${{ matrix.app }}:latest
          