name: CI

permissions:
  contents: write

on:
  push:
    branches: [main, development, staging]
  pull_request: {}
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        default: "patch"
        type: choice
        options: [patch, minor, major]

jobs:
  # ============================================
  # 1Ô∏è‚É£ TESTS
  # ============================================
  backend-test:
    name: ‚öôÔ∏è Backend tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - working-directory: apps/backend
        run: |
          npm ci
          npm run lint
          npm test

  frontend-test:
    name: üñ•Ô∏è Frontend tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - working-directory: apps/frontend
        run: |
          npm ci --legacy-peer-deps
          npm run lint

  # ============================================
  # 2Ô∏è‚É£ VERSIONING & TAGGING
  # ============================================
  versioning:
    name: üè∑Ô∏è Versioning
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: github.event_name != 'pull_request'
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.value }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin --tags

      # üöÄ MAIN: Release version (1.0.0)
            # üöÄ MAIN: Release version (1.0.0)
      - name: Release on main
        if: github.ref_name == 'main' && github.actor != 'github-actions[bot]'
        run: |
          TYPE="${{ github.event.inputs.release_type || 'patch' }}"
          (cd apps/backend && npm version $TYPE --no-git-tag-version && NEW_VER=$(node -p "require('./package.json').version"))
          NEW_VER=$(node -p "require('./apps/backend/package.json').version")
          git add apps/backend/package.json apps/backend/package-lock.json apps/frontend/package.json apps/frontend/package-lock.json
          git commit -m "chore(release): v$NEW_VER"
          git tag "v$NEW_VER"
          git push origin HEAD:main --follow-tags

            # üß™ DEVELOPMENT: Snapshot version (1.0.0-snapshot.1)
      - name: Snapshot on development
        if: github.ref_name == 'development'
        run: |
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1 || echo "v1.0.0")
          BASE="${LATEST_TAG#v}"
          LAST_SNAP=$(git tag --sort=-v:refname | grep "^v${BASE}-snapshot" | head -1)
          if [ -z "$LAST_SNAP" ]; then N=1; else N=$(echo $LAST_SNAP | grep -o '[0-9]*$'); N=$((N+1)); fi
          NEW="${BASE}-snapshot.${N}"
          
          # Bump versions
          (cd apps/backend && npm version $NEW --no-git-tag-version 2>/dev/null || true)
          (cd apps/frontend && npm version $NEW --no-git-tag-version 2>/dev/null || true)
          
          # Commit & tag
          git add apps/backend/package.json apps/backend/package-lock.json apps/frontend/package.json apps/frontend/package-lock.json
          git commit -m "chore(snapshot): v$NEW" || true
          git tag "v$NEW"
          git push origin HEAD:development --follow-tags

      # üß∑ STAGING: RC version (1.0.0-RC.1)
            # üß∑ STAGING: RC version (1.0.0-RC.1)
      - name: RC on staging
        if: github.ref_name == 'staging'
        run: |
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | grep -v RC | head -1 || echo "v1.0.0")
          BASE="${LATEST_TAG#v}" && BASE="${BASE%-snapshot*}"
          LAST_RC=$(git tag --sort=-v:refname | grep "^v${BASE}-RC" | head -1)
          if [ -z "$LAST_RC" ]; then N=1; else N=$(echo $LAST_RC | grep -o '[0-9]*$'); N=$((N+1)); fi
          NEW="${BASE}-RC.${N}"
          
          (cd apps/backend && npm version $NEW --no-git-tag-version 2>/dev/null || true)
          (cd apps/frontend && npm version $NEW --no-git-tag-version 2>/dev/null || true)
          
          git add apps/backend/package.json apps/backend/package-lock.json apps/frontend/package.json apps/frontend/package-lock.json
          git commit -m "chore(rc): v$NEW" || true
          git tag "v$NEW" --force
          git push origin HEAD:staging --follow-tags

      - id: tag
        run: echo "value=$(git tag --sort=-creatordate | head -1)" >> $GITHUB_OUTPUT

  # ============================================
  # 3Ô∏è‚É£ DOCKER BUILD & PUSH
  # ============================================
  docker-frontend:
    name: üê≥ Build & Push Frontend
    runs-on: ubuntu-latest
    needs: [versioning]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v1
        with:
          login-server: cmatheo.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - run: docker build -t cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }} apps/frontend
      - run: docker push cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }}
      - if: github.ref_name == 'main'
        run: |
          docker tag cmatheo.azurecr.io/frontend:${{ needs.versioning.outputs.tag }} cmatheo.azurecr.io/frontend:latest
          docker push cmatheo.azurecr.io/frontend:latest

  docker-backend:
    name: üê≥ Build & Push Backend
    runs-on: ubuntu-latest
    needs: [versioning]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v1
        with:
          login-server: cmatheo.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - run: docker build -t cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }} apps/backend
      - run: docker push cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }}
      - if: github.ref_name == 'main'
        run: |
          docker tag cmatheo.azurecr.io/backend:${{ needs.versioning.outputs.tag }} cmatheo.azurecr.io/backend:latest
          docker push cmatheo.azurecr.io/backend:latest